<div id="myModal" class="modal">

  <!-- Modal content -->
  <div class="modal-content">
    <span class="close-popup">&times;</span>
    <div class="cushion-block-cust">
   <div class="container">
    
      <div class="cushion-box">
         <div class="cushion-header">
            <h2>Step 1 <span>Enter cushion measurements</span></h2>
         </div>
         <div class="cushion-body">
            <div class="wrap-des">
               <p class="cushion-description">
                  Enter the length, width, and thickness in inches for your custom cushion.
               </p>
               <a href="https://example.com/how-to-measure" class="cushion-link" target="_blank">
               How to Measure <span><img src="https://cdn.shopify.com/s/files/1/0614/7453/7714/files/open_in_new_5c155c20-bb91-4b37-9b3c-a8b73e30230d.svg?v=1745218334"></span>
               </a>
            </div>
            <div class="cushion-fields" id="dimension-fields">
            </div>
            <!-- /cushion-fields -->
         </div>
         <!-- /cushion-body -->
      </div>

   </div>
</div>
    <!-- ------------------------------------ section 2 ----------------------------------- -->
   
<div class="step-box-layout">
   <div class="container">
      <div class="vn-custom">
      <div class="step-box">
         <div class="step-header">
            <h2>Step 2 <span>Select Your Fabric</span></h2>
         </div>
         <div class="fabric-inner-block">
            <div class="fabric-search-header">
               <div class="fabric-instructions">
                  <p>Select a fabric based on your cushion's location and use.</p>
               </div>
               <div class="fabric-search">
                  <input type="text" class="fabric-input" placeholder="Search Fabrics by color or pattern" />
                  <button class="fabric-search-btn">
                     <svg width="64px" height="64px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#ffffff">
                        <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                        <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                        <g id="SVGRepo_iconCarrier">
                           <path d="M15.7955 15.8111L21 21M18 10.5C18 14.6421 14.6421 18 10.5 18C6.35786 18 3 14.6421 3 10.5C3 6.35786 6.35786 3 10.5 3C14.6421 3 18 6.35786 18 10.5Z" stroke="#ffffff" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"></path>
                        </g>
                     </svg>
                  </button>
               </div>
            </div>
            <div class="filter-bar">
               <div class="wrap-filter">
                  <button class="clear-btn">Clear Filters</button>
               </div>
               <div class="wrap-select">
                  <ul class="vn-dropdown">
                     <li class="dop_parent_filter" id=fabricFeature>
                        <span class="vn-tab-name" href="#">Features</span>
                        <ul class="sub-filter">
                        </ul>
                     </li>
                     <li class="dop_parent_filter" id="fabricColor">
                        <span class="vn-tab-name" href="#">Color</span>
                        <ul class="sub-filter">
                        </ul>
                     </li>
                     <li class="dop_parent_filter" id="fabricPattern">
                        <span class="vn-tab-name" href="#">Pattern</span>
                        <ul class="sub-filter">
                        </ul>
                     </li>
                     <li class="dop_parent_filter" id="fabricType">
                        <span class="vn-tab-name" href="#">Fabric Type</span>
                        <ul class="sub-filter">
                        </ul>
                     </li>
                  </ul>
               </div>
            </div>
            <div class="wrap-fabric-btn">
               <div class="fabric-buttons">
                  <button class="btn-popular an-fab-btn active" data-tab="1" data-popular="yes">Most Popular</button>
                  <button class="btn-more an-fab-btn" data-tab="2">More Choices</button>
                  <div class="wrap-select more-choices">
                     <ul class="vn-dropdown">
                        <li class="dop_parent_filter" id="moreChoices">
                           <span class="vn-tab-names" href="#">More Choices</span> 
                           <ul class="sub-filter">
                              <li value="Washable" class=""><label for="Washable"><input id="Washable" type="checkbox" value="Washable"><span>Washable</span></label></li>
                              <li value="Non-washable" class=""><label for="Non-washable"><input id="Non-washable" type="checkbox" value="Non-washable"><span>Non-washable</span></label></li>
                              <li value="Dry-clean" class=""><label for="Dry-clean"><input id="Dry-clean" type="checkbox" value="Dry-clean"><span>Dry-clean</span></label></li>
                           </ul>
                        </li>
                     </ul>
                  </div>
                  <img id="lifestyleimage" src="">
               </div>
               <div class="fabric-thumbnail-wraper">
                  <div class="fabric-thumbnails active" id="fab-1">                  
                  </div>
               </div>
               </div>
               <div class="pagination">
                  <div class="prev-page">
                     <img src="https://cdn.shopify.com/s/files/1/0614/7453/7714/files/Group_44.svg?v=1747995876">
                  </div>
                  <span class="page-num">1 of 1</span>
                  <div class="next-page">
                     <img src="https://cdn.shopify.com/s/files/1/0614/7453/7714/files/Group_44_1.svg?v=1747995876">
                  </div>
               </div>
               <div class="note">
                  <p>**Colors may differ from their appearance on your screen due to monitor variations, and dye lots
                     may vary. We recommend ordering fabric samples to compare with your decor. Order fabric samples
                     <a href="#">here</a>.
                  </p>
               </div>
           
         </div>
      </div>
   </div>
</div>
    </div>
    <!-- ---------------------------- section-3 ----------------------------- -->
   <script>
      $(document).ready(function () {
          $('body').on('click', '.options .option', function () {
              $('.options .option').removeClass('vn-active');
              $(this).addClass('vn-active');
          });
      
       
      });
   </script>
   <div class="wrap-option-sec">
      <div class="container">
         <div class="vn-custom">
         <div class="wrap-block-option fiber-fill">
            <div class="header step-title">
               <h2>Step 3 <span>Choose Foam or Fiberfill</span></h2>
            </div>
            <div class="custom-section">
               <p>Note:Fiber filling cushion thickness is measured from the center of the cushion where
                  it is most fluffy. Sides of the cushion will be little smaller.
               </p>
               <div class="option-row">
               </div>
            </div>
         </div>
         </div>
      </div>
   </div>
   <script>
      $(document).ready(function () {
          $('body').on('click', '.block-btnn, .block-option', function () {
              $(this).parent().addClass('vn-active-btn').siblings().removeClass('vn-active-btn');
              // $(this).addClass('vn-active-btn');
          });
      });
   </script>
   <!-- ------------------- section-4 --------------------- -->
   <div class="customization-container-section">
      <div class="container">
         <div class="vn-custom">
         <div class="wrap-customization customization-container">
            <div class="customization-header">
               <h2>Step 4 <span> More Customizations</span></h2>
            </div>
            <!-- Zipper Position -->
            <div class="custom-section zipper-options">
               <h4>Zipper Position</h4>
               <p>Choose between long side or short side zippers for easy removal and cleaning.</p>
               <div class="option-row">
                  <div class="custom-option vn-active-btn">
                     <div class="block-option">
                        <img src="https://cdn.shopify.com/s/files/1/0614/7453/7714/t/30/assets/dpo_custom_option_88782_5.png?v=1678749590"
                           alt="Long Side">
                     </div>
                     <div class="block-btnn">
                        <button class="custom-btn">Long Side</button>
                     </div>
                  </div>
                  <div class="custom-option">
                     <div class="block-option">
                        <img src="https://cdn.shopify.com/s/files/1/0614/7453/7714/t/30/assets/dpo_custom_option_33644_4.png?v=1678749611"
                           alt="Long Side">
                     </div>
                     <div class="block-btnn">
                        <button class="custom-btn">Short Side</button>
                     </div>
                  </div>
               </div>
            </div>
            <!-- Piping -->
            <div class="custom-section piping-options">
               <h4>Piping</h4>
               <p>Select either no piping for a clean edge or add piping for a decorative touch.</p>
               <div class="option-row">
                  <div class="custom-option vn-active-btn">
                     <div class="block-option">
                        <img src="https://cdn.shopify.com/s/files/1/0614/7453/7714/files/dpo_custom_option_12070_untitled-design-1.png?v=1728936644"
                           alt="Long Side">
                     </div>
                     <div class="block-btnn">
                        <button class="custom-btn">No Piping</button>
                     </div>
                  </div>
                  <div class="custom-option">
                     <div class="block-option">
                        <img src="https://cdn.shopify.com/s/files/1/0614/7453/7714/files/dpo_custom_option_34015_etsy-redesign-piping-ties-1.png?v=1728936674"
                           alt="Long Side">
                     </div>
                     <div class="block-btnn">
                        <button class="custom-btn">Piping</button>
                     </div>
                  </div>
               </div>
            </div>
            <!-- Ties -->
            <div class="custom-section ties-options">
               <h4>Ties</h4>
               <p>Decide between no ties for a simpler look, or choose from 2-side, 4-side, or 4-corner ties for secure attachment.</p>
               <div class="option-row">
                  <div class="custom-option vn-active-btn">
                     <div class="block-option">
                        <img src="https://cdn.shopify.com/s/files/1/0614/7453/7714/files/dpo_custom_option_70850_no-ties.png?v=1728936872"
                           alt="Long Side">
                     </div>
                     <div class="block-btnn">
                        <button class="custom-btn">No Ties</button>
                     </div>
                  </div>
                  <div class="custom-option">
                     <div class="block-option">
                        <img src="https://cdn.shopify.com/s/files/1/0614/7453/7714/files/dpo_custom_option_40335_2-sides.png?v=1728936908"
                           alt="Long Side">
                     </div>
                     <div class="block-btnn">
                        <button class="custom-btn">2 Side</button>
                     </div>
                  </div>
                  <div class="custom-option">
                     <div class="block-option">
                        <img src="https://cdn.shopify.com/s/files/1/0614/7453/7714/files/dpo_custom_option_14047_4-corners.png?v=1728936924"
                           alt="Long Side">
                     </div>
                     <div class="block-btnn">
                        <button class="custom-btn">4 Corner</button>
                     </div>
                  </div>
                  <div class="custom-option">
                     <div class="block-option">
                        <img src="https://cdn.shopify.com/s/files/1/0614/7453/7714/files/dpo_custom_option_27956_4-sides.png?v=1728936941"
                           alt="Long Side">
                     </div>
                     <div class="block-btnn">
                        <button class="custom-btn">4 Side</button>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>
   </div>
   </div>
   <!-- ------------------- section-5 --------------------- -->
   <div class="wrapping-steps">
      <div class="container">
         <div class="vn-custom">
         <div class="design-step-container">
            <div class="design-step-header">
               <h2>Step 5 <span>Special Design Instructions</span></h2>
            </div>
            <div class="design-step-content">
               <!-- Left Section -->
               <div class="design-left">
                  <h2>Provide design details or upload image for a Perfect Fit</h2>
                  <label>
                     Images (Optional)
                     <span class="info-icon">i</span>
                     <div class="vn-hover-popup">Provide specific design requests or upload reference images to guide your customization, ensuring your cushion is tailored to your exact vision.</div>
                  </label>
                  <input type="file" name="custom_upload" id="customUpload" accept=".png,.jpg,.jpeg,.gif,.pdf,.doc">
                  <div class="file-info">
                     Allowed file extensions: png, jpg, jpeg, gif, pdf, doc
                  </div>
               </div>
               <!-- Right Section -->
               <div class="design-right">
                  <label>Comments/Instructions</label>
                  <textarea placeholder="Let us know if you have any special instructions."></textarea>
               </div>
            </div>
         </div>
         </div>
      </div>
   </div>
   <!-- ------------------- section-6 --------------------- -->
   <div class="wrap-summary">
      <div class="container">
         <div class="vn-custom">
         <div class="summary-container">
            <div class="summary-header">Your Customization Summary</div>
            <table class="summary-table">
               <tr>
                  <td>Category:</td>
                  <td class="selectedCategory">Most Popular</td>
               </tr>
               <tr>
                  <td>Fabric:</td>
                  <td class="fabricValue"></td>
               </tr>
               <tr>
                  <td>Fill:</td>
                  <td class="fillOption">High Density Foam</td>
               </tr>
               <tr>
                  <td>Zipper Position:</td>
                  <td class="zipperOption">Short Side</td>
               </tr>
               <tr>
                  <td>Piping:</td>
                  <td class="pipingOption">None</td>
               </tr>
               <tr>
                  <td>Ties:</td>
                  <td class="tieOption">None</td>
               </tr>
               <tr>
                  <td class="summary-price">Price (with selected options):</td>
                  <td class="summary-price" id="total-price">$20.29</td>
               </tr>
            </table>
         </div>
         </div>
      </div>
   </div>

    <div class="custom-btn-group">
     <div class="add-to-configure-btn">
       <a href="javascript:void(0)">Update Cart</a>
       <div id="config-loader" style="display:none;"></div>
     </div>
      <div class="cancel-btn">
     <a href="javascript:void(0)" class="cancel-btnn">Cancel</a>
      </div>
    </div>
   <div class="price-btn">
      <button>$93.81</button>
   </div>
  </div>

</div>

<style>

div#config-loader {
    height: 20px;
    width: 20px;
    border: 3px solid #f3f3f3;
    border-radius: 50%;
    border-top: 3px solid #3498db;
    -webkit-animation: spin 2s linear infinite; /* Safari */
  animation: spin 2s linear infinite;
}
.add-to-configure-btn {
    background: #000;
    color: #fff;
    padding: 10px 40px;
    font-size: 16px;
    font-weight: 600;
    border-radius: 8px;
    display: flex;
    text-align: center;
    justify-content: center;
    align-items: center;
    gap: 15px;
}  
  .add-to-configure-btn a {
    color: #ffff;
}
  .cancel-btn {
    width: 40%;
}
 .modal-content button.custom-btn { 
    font-size: 12px;
}
 .modal-content .vn-active-btn button.custom-btn {
    padding: 12px 10px;
    font-size: 10px;
    line-height: 13px;
}
.modal-content .cushion-box, .modal-content .step-box,  .modal-content .wrap-block-option, .modal-content .wrap-customization, 
.modal-content .design-step-container, .modal-content .summary-container{
    width: 100%;
    max-width: 80%;
}
  .custom-btn-group {
    display: flex;
    justify-content: space-between;
    max-width: 80%;
    width: 100%;
    margin: 0 auto;
    align-items: center;
    gap: 20px;
    margin-top: 30px;
}
.add-to-configure-btn.container a, .cancel-btn a {
    background: #000;
    color: #fff;
    padding: 10px 40px;
    font-size: 16px;
    font-weight: 600;
    border-radius: 8px;
    display: block;
    text-align: center;
}
  .info-section {
    display: flex;
    gap: 20px;
     border-radius: 5px;
    max-width: 80%;
    width: 100%;
    margin: 0 auto;
    margin-bottom: 40px;
}
  .wrap-customization .custom-option {
    gap: 33px;
}
 .wrap-block-option .custom-option {
    gap: 34px;
}
.modal.active {
    display: block;
  z-index: 9999;
}
  .step-box .fabric-search {
    max-height: fit-content;
}
.modal {
  display: none; /* Hidden by default */
  position: fixed; /* Stay in place */
  z-index: 1; /* Sit on top */
  /* padding-top: 100px; /* Location of the box */ */
  left: 0;
  top: 0;
  width: 100%; /* Full width */
  height: 100%; /* Full height */
  overflow: auto; /* Enable scroll if needed */
  background-color: rgb(0,0,0); /* Fallback color */
  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
}

/* Modal Content */
.modal-content {
    background-color: #fefefe;
    margin: auto;
    padding: 20px;
    border: 1px solid #888;
    width: 100%;
    max-width: 60%;
}
 .modal-content .cushion-box h2, .modal-content .step-box h2,  .modal-content .wrap-block-option h2, .modal-content .wrap-customization h2, 
.modal-content .design-step-container h2, .modal-content .summary-container h2{
    display: flex;
    font-family: poppins;
}
.wrap-block-option button.custom-btn {
    font-size: 12px;
    padding: 10px 5px;
}
/* The Close Button */
.close-popup {
    color: #000000;
    float: right;
    font-size: 19px;
    font-weight: bold;
    background: transparent;
    border: 1px solid;
    padding: 0 10px;
    margin-bottom: 10px;
    top: -10px;
}

.close-popup:hover,
.close-popup:focus {
  color: #000;
  text-decoration: none;
  cursor: pointer;
}
.wrap-box.vn-active-btn .thumb img {
    border: 3px solid red;
    padding: 3px;
}
.fabric-input:focus {
    outline: none;
    box-shadow: none;
}
.next-page, .prev-page, .option, .custom-option, .wrap-box, .an-fab-btn {
    cursor: pointer;
}
button.btn-more.an-fab-btn {
    display: none;
}  
  .vn-custom {
    width: 100%;
    max-width: 100%;
    margin: 0 auto;
}
  @media (max-width: 500px){
    .wrap-block-option .custom-option {
    gap: 24px!important;
}
    .wrap-customization h2 span {
    font-size: 17px;
}
  }
@media (max-width: 768px){
.custom-btn-group .container {
    display: unset;
    padding: 0;
}
  .cancel-btn {
    width: 100%;
}
  .custom-btn-group {
    gap: 10px;
    flex-direction: column;
}
  .wrap-block-option .custom-option {
    gap: 124px;
}
}
  
    @media (max-width: 992px){
    .modal-content {
    width: 100%!important;
    max-width: 100%!important;
}
  .modal-content .cushion-box, .modal-content .step-box,  .modal-content .wrap-block-option, .modal-content .wrap-customization, 
.modal-content .design-step-container, .modal-content .summary-container{
    max-width: 100%;
    width: 100%;
}
    .info-section {
    max-width: 100%;
    width: 100%;
    flex-direction: column;
}
      .modal-content { 
    padding: 0;
}
  }
  
</style>

<script>
$(document).ready(function() {
  var $modal = $("#myModal");
  var $btn = $("#myBtn");
  var $span = $(".close-popup");

  // When the user clicks the button, open the modal
  $btn.on("click", function() {
    $modal.show();
  });

  // When the user clicks on <span> (x), close the modal
  $span.on("click", function() {
    $modal.removeClass('active');
  });

  // When the user clicks anywhere outside of the modal, close it
  $(window).on("click", function(event) {
    if ($(event.target).is($modal)) {
      $modal.removeClass('active');
    }
  });

  $('.dop_parent_filter span.vn-tab-name').click(function() {
    $(this).toggleClass('an-active');
  });

  $('.an-fab-btn').click(function() {
    var tabID = $(this).attr('data-tab');
    $(this).addClass('active').siblings().removeClass('active');
    $('#fab-' + tabID).addClass('active').siblings().removeClass('active');
   
  });
  $('button.btn-popular.an-fab-btn').click(function() {
       $('.more-choices.wrap-select.an-active, li#moreChoices span.vn-tab-names.an-active').removeClass('an-active');
    
  });
  
$('.add-to-configure-btn').click(function () {
    $('#config-loader').show();

    var $modal = $(this).closest('#myModal');
    var productId = $modal.data('productid');
    var oldVariantId = $modal.data('variantid');
    var productSku = $modal.data('variantsku');

    if (!oldVariantId) {
        alert('Variant ID not found.');
        return;
    }

    const updates = {};
    updates[oldVariantId] = 0;

    var length = $('.length_1').find(':selected').val();
    var width = $('.width_2').find(':selected').val();
    var thickness = $('.thickness_3').find(':selected').val();
    var fabric_name = $('.wrap-box.vn-active-btn').data('fabric-name');
    var fill_name = $('.fiber-fill .custom-option.vn-active-btn').data('name');
    var zipper_name = $('.zipper-options .custom-option.vn-active-btn').data('name');
    var piping_name = $('.piping-options .custom-option.vn-active-btn').data('name');
    var ties_name = $('.ties-options .custom-option.vn-active-btn').data('name');
    var textareaNote = $('.design-right textarea').val();

    const fileInput = $('#customUpload')[0];
    const file = fileInput.files[0];

    $.getJSON('/cart.js', function (cart) {
        let needsNewVariant = true;

        cart.items.forEach(function (item) {
            if (item.variant_id == oldVariantId) {
                const props = item.properties;

                if (
                    props['Length'] === length &&
                    props['Width'] === width &&
                    props['Thickness'] === thickness &&
                    props['Fabric'] === fabric_name &&
                    props['Fill Option'] === fill_name &&
                    props['Zipper Option'] === zipper_name &&
                    props['Piping Option'] === piping_name &&
                    props['Ties Option'] === ties_name
                ) {
                    needsNewVariant = false;
                    location.reload();
                    return false;
                }
            }
        });

        if (needsNewVariant) {
            $.ajax({
                type: 'POST',
                url: '/cart/update.js',
                contentType: 'application/json',
                dataType: 'json',
                data: JSON.stringify({ updates: updates }),
                success: function () {
                    var data = {
                        prices: $('.wrap-box.vn-active-btn').data('prices'),
                        length: $('select.length_1').find(':selected').val() || $('select.length_4').find(':selected').val(),
                        width: $('select.width_2').find(':selected').val() || $('select.width_5').find(':selected').val(),
                        height: $('select.thickness_3').find(':selected').val() || $('select.thickness_6').find(':selected').val(),
                        fabric_name: $('.wrap-box.vn-active-btn .hover-icon .hover-i-img-text').text().trim(),
                        fill: $('.wrap-block-option.fiber-fill .custom-option.vn-active-btn .custom-btn').text().trim(),
                        zipper: $('.zipper-options .custom-option.vn-active-btn .custom-btn').text().trim(),
                        piping: $('.piping-options .custom-option.vn-active-btn .custom-btn').text().trim(),
                        ties: $('.ties-options .custom-option.vn-active-btn .custom-btn').text().trim(),
                        quantity: 1,
                        different_piping_fabric: false
                    };

                    const final_price = calculateQuote(data);
                    const formData = new FormData();
                    formData.append('productId', productId);
                    formData.append('productSku', productSku);
                    formData.append('totalPrice', final_price);
                    if (file) {
                        formData.append('custom_upload', file);
                    }

                    $.ajax({
                        url: 'https://app.zipcushions.com/zipcushion-app/createVariant',
                        type: 'POST',
                        dataType: 'json',
                        data: formData,
                        contentType: false,
                        processData: false,
                        success: function (item) {
                            const newVariantId = item.variantId;
                            const fileUrl = item.fileUrl;
                            const productHandle = $modal.data('producthandle');

                            function pollForVariant() {
                                $.getJSON(`/products/${productHandle}.js`, function (product) {
                                    const found = product.variants.find(v => v.id == newVariantId);
                                    if (found) {
                                        // Variant available, add to cart
                                        $.ajax({
                                            type: 'POST',
                                            url: '/cart/add.js',
                                            data: {
                                                quantity: 1,
                                                id: newVariantId,
                                                properties: {
                                                    'Length': length,
                                                    'Width': width,
                                                    'Thickness': thickness,
                                                    'Fabric': fabric_name,
                                                    'Fill Option': fill_name,
                                                    'Zipper Option': zipper_name,
                                                    'Piping Option': piping_name,
                                                    'Ties Option': ties_name,
                                                    'Instructions': textareaNote,
                                                    'Uploaded Image': fileUrl
                                                }
                                            },
                                            dataType: 'json',
                                            success: function () {
                                                window.location.href = "/cart?timestamp=" + new Date().getTime();
                                            }
                                        });
                                    } else {
                                        setTimeout(pollForVariant, 2000); // Retry every 2s
                                    }
                                });
                            }

                            pollForVariant();
                        },
                        error: function (xhr, status, error) {
                            console.error('Variant creation failed:', error);
                        }
                    });
                },
                error: function (xhr, status, error) {
                    console.error('Cart update failed:', error);
                }
            });
        }
    });
});


  $('.cancel-btnn').click(function(){
    $('#myModal.active').removeClass('active');
  });

  setTimeout(function() {
            let length = null,
                width = null,
                height = null;
            $('.cushion-field').each(function() {
                const label = $(this).find('label').text().trim().toLowerCase();
                const value = parseInt($(this).find('select option:selected').val()) || 0;

                if (label.includes('length') && length === null) {
                    length = value;
                } else if (label.includes('width') && width === null) {
                    width = value;
                } else if ((label.includes('height') || label.includes('thickness')) && height === null) {
                    height = value;
                }
            });
            var data = {
                prices: $('.wrap-box.vn-active-btn').data('prices'),
                length: length || 0,
                width: width || 0,
                height: height || 0,
                fabric_name: $('.wrap-box.vn-active-btn .hover-icon .hover-i-img-text').text().trim(),
                fill: $('.wrap-block-option.fiber-fill .custom-option.vn-active-btn .custom-btn').text().trim(),
                zipper: $('.zipper-options .custom-option.vn-active-btn .custom-btn').text().trim(),
                piping: $('.piping-options .custom-option.vn-active-btn .custom-btn').text().trim(),
                ties: $('.ties-options .custom-option.vn-active-btn .custom-btn').text().trim(),
                quantity: 1, // Set default or get from user input
                different_piping_fabric: false // Default, or get from another toggle/input
            };

            var final_price = calculateQuote(data);
            $('#total-price').text('$' + final_price);
            $('.price-btn button').text('$' + final_price);

            var length_1 = $('select.length_1').find(':selected').val();
            var length_4 = $('select.length_4').find(':selected').val();
            var width_2 = $('select.width_2').find(':selected').val();
            var width_5 = $('select.width_5').find(':selected').val();
            var thickness_3 = $('select.thickness_3').find(':selected').val();
            var thickness_6 = $('select.thickness_6').find(':selected').val();

            var selectedFabric = $('.wrap-box.vn-active-btn .hover-icon .hover-i-img-text').text();
            var fillOption = $('.wrap-block-option.fiber-fill .custom-option.vn-active-btn .custom-btn').text();
            var zipperOption = $('.zipper-options .custom-option.vn-active-btn .custom-btn').text();
            var pipingOption = $('.piping-options .custom-option.vn-active-btn .custom-btn').text();
            var tiesOption = $('.ties-options .custom-option.vn-active-btn .custom-btn').text();

            $('.fabricValue').text(selectedFabric);
            $('.pipingOption').text(pipingOption);
            $('.tieOption').text(tiesOption);
            $('.fillOption').text(fillOption);
            $('.zipperOption').text(zipperOption);
            $('.lenthValue').text(length_1);
            $('.widthValue').text(width_2);
            $('.thicknessValue').text(thickness_3);

        }, 5000);
   /** calulate price */
        function calculateQuote(data) {
            var getShapeDate = localStorage.getItem("fabricShape");
            const raw_length = parseFloat(data.length);
            const raw_width = parseFloat(data.width);
            const raw_height = parseFloat(data.height);
            const shape = getShapeDate;
            const fill_type = data.fill.toLowerCase();
            const piping = data.piping ? data.piping.toLowerCase() : 'no';
            const different_piping_fabric = data.different_piping_fabric || false;
            const ties = (data.ties || 'no').toString().toLowerCase();
            const prices = parseFloat(data.prices);
            //alert(prices+'price');

            if (!data.fabric_name) {
                return {
                    success: false,
                    error: 'Missing fabric_name'
                };
            }

            /** const match = fabricSheet.find(row => row.Fabric === data.fabric_name);
             if (!match) {
                 return { success: false, error: 'Fabric not found' };
             } */

            const fabric_price = prices;
            const quantity = parseInt(data.quantity) || 1;
            const length = Math.ceil(raw_length * 2) / 2;
            const width = Math.ceil(raw_width * 2) / 2;
            const height = Math.ceil(raw_height);

            const shape_base_map = {
                'round': 15,
                't-shape': 20,
                'tapered': 20,
                'l-shape': 15,
                'triangle': 10,
                'trapezium': 15,
                'bolster': 10,
                'semi-round': 10
            };
            const shape_base = shape_base_map[shape] || 0.1;

            const side1 = (2 * height) + Math.max(length, width);
            const side2 = (2 * height) + Math.min(length, width);


            let fabric_inches;
            if (side1 <= 27) fabric_inches = side2;
            else if (side1 <= 54) fabric_inches = 2 * side2;
            else if (side2 > 54) fabric_inches = 6 * side2;
            else if (side2 <= 27) fabric_inches = side1;
            else fabric_inches = 2 * side1;

            const yards = fabric_inches * 0.028;
            const fabric_cost = yards * fabric_price;

            const max_side = Math.max(length, width);
            let labor = 25;
            if (max_side <= 24) labor = 8;
            else if (max_side <= 48) labor = 12;
            else if (max_side <= 72) labor = 16;
            else if (max_side <= 96) labor = 20;

            let foam_multiplier = 0.596;
            if (max_side <= 12) foam_multiplier = 0.063;
            else if (max_side <= 18) foam_multiplier = 0.095;
            else if (max_side <= 36) foam_multiplier = 0.179;
            else if (max_side <= 48) foam_multiplier = 0.264;
            else if (max_side <= 60) foam_multiplier = 0.322;
            else if (max_side <= 72) foam_multiplier = 0.390;
            else if (max_side <= 84) foam_multiplier = 0.459;
            else if (max_side <= 96) foam_multiplier = 0.528;

            const foam = foam_multiplier * Math.min(length, width) * height;

            let fill_cost;
            if (fill_type === "dry fast foam") fill_cost = foam * 1.4;
            else if (fill_type === "fiber fill") fill_cost = 0.004 * length * width * height;
            else if (fill_type === "covers only") fill_cost = 0;
            else fill_cost = foam;

            let piping_cost = 0;
            if (piping === 'piping') {
                if (max_side <= 24) piping_cost = 12;
                else if (max_side <= 48) piping_cost = 18;
                else if (max_side <= 72) piping_cost = 24;
                else if (max_side <= 96) piping_cost = 30;
                else piping_cost = 36;
                if (different_piping_fabric) piping_cost *= 2;
            }

            const tie_map = {
                "no": 0,
                "2": 10,
                "4": 16,
                "8": 22
            };
            const ties_cost = tie_map[ties] !== undefined ? tie_map[ties] : 28;

            let packaging = 8;
            if (fill_type === "covers") packaging = 4;
            else if (max_side <= 24) packaging = 3.2;
            else if (max_side <= 48) packaging = 4;
            else if (max_side <= 72) packaging = 5.6;
            else if (max_side <= 96) packaging = 6.4;

            let shipping;
            if (fill_type === "covers") {
                const fabric_weight = Math.ceil(226.8 * yards / 1000);
                shipping = (1200 * fabric_weight / 75) * 1.2;
            } else {
                const volume_in = length * width * height;
                const volume_cm = volume_in * 16.387064;
                const compressed_volume = volume_cm * 0.2 * 1.2;
                const volume_weight = compressed_volume / 5000;
                const base_shipping = volume_weight <= 11 ?
                    (800 * volume_weight / 75) : (700 * volume_weight / 75);
                const fabric_weight = Math.ceil(226.8 * yards / 1000);
                const alt_shipping = (1200 * fabric_weight / 75) * 1.2;
                shipping = Math.max(base_shipping, alt_shipping);
                if (length > 45 && width > 45) shipping += 35;
            }

            const unit_subtotal = shape_base + fabric_cost + labor + fill_cost + piping_cost + ties_cost + packaging + shipping;
            const subtotal = unit_subtotal * quantity;
            const unit_final_price = Math.round(unit_subtotal * 2.05 * 100) / 100;
            const final_price = Math.round(subtotal * 2.05 * 100) / 100;

            return final_price;

        }


        /** end calculate price */
});
</script>
