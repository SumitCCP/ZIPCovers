{% comment %} base schema structure {% endcomment %}
{% assign org_id = shop.url | append: '#org' %}
{% assign site_id = shop.url | append: '#website' %}
<script type="application/ld+json">
{
  "@context":"https://schema.org",
  "@graph":[
{
  "@type":"Organization",
  "name": {{ shop.name | json }},
  "url": {{ shop.url | json }},
  "logo": {{ shop.logo | default: shop.url | json }},
  "email": "support@zipcushions.com",
  "telephone": "+1 720-627-7225",
  "address": {
    "@type":"PostalAddress",
    "streetAddress": "1499 W 120th Ave #110",
    "addressLocality": "Westminster",
    "addressRegion": "CO",
    "postalCode": "80234",
    "addressCountry": "US"
  },
  "sameAs": []
},
    {
      "@type":"WebSite",
      "url": {{ shop.url | json }},
      "name": {{ shop.name | json }},
  "potentialAction": {
  "@type": "SearchAction",
  "target": {{ shop.url | append: '/search?q=%7Bsearch_term_string%7D' | json }},
  "query-input": "required name=search_term_string"
}

    }
  ]
}
</script>



{% comment %}
  Article structured data
{% endcomment %}
 
{% if template contains 'article' %}
  {%- capture article_description  -%}
    {%- if article.excerpt != blank -%}
      {{ article.excerpt | strip_html }}
    {%- else -%}
      {{ article.content | truncatewords: 100 | strip_html }}
    {%- endif -%}
  {%- endcapture -%}

  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "BlogPosting",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "{{ shop.url }}{{ article.url }}"
      },
      "headline": {{ article.title | json }},
      {% if article.image %}
        "image": {
          "@type": "ImageObject",
          "url": {{ article.image | img_url: '800x800' | prepend: 'https:' | json }},
          "height": 800,
          "width": 800
        },
      {% endif %}
      "datePublished": {{ article.published_at | date: '%Y-%m-%dT%H:%M:%S%z' | json}},
      "dateModified": {{ article.published_at | date: '%Y-%m-%dT%H:%M:%S%z' | json}},
      "author": {
        "@type": "Person",
        "name": {{ article.author | json }}
      },
      "publisher": {
        "@type": "Organization",
        "name": {{ shop.name | json }},
        "logo": {
          "@type": "ImageObject",
          "url": {{ article.user.image | img_url: '200x200' | prepend: 'https:' | json }}
        }
      },
      "description": {{ article_description| strip_html  | json }}
    }
  </script>
{% endif %}

{% comment %}
  Breadcrumbs
{% endcomment %}

{%- if current_tags -%}
  {%- assign tag_names = current_tags | join: ', ' %}
  {%- capture tag_handles -%}
    {%- for tag in current_tags -%}
      {{- tag | handle | append: '|' -}}
    {%- endfor -%}
  {%- endcapture -%}
{%- endif -%}

{% if collection.url == blank %}
  {% assign collection_url = '/collections/all' %}
{% else %}
  {% assign collection_url = collection.url %}
{% endif %}

{% if template.name == 'product' 
    or template.name == 'list-collections' 
    or template.name == 'collection' 
    or template.name == 'blog' 
    or template.name == 'article' 
    or template.name == 'search' 
    or template.name == 'cart' 
    or template.name == 'page'
%}

  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
      {% case template.name %}
        {% when 'product' %}
            {
              "@type": "ListItem",
              "position": 1,
              "item": {
                "@id": "{{ shop.url }}",
                "name": "Home"
              }
            },
            {
              "@type": "ListItem",
              "position": 2,
              "item": {
                "@id": "{{ shop.url }}{{ product.url }}",
                "name": {{ product..title | json }}
              }
            }
        {% when 'list-collections' %}
          {
            "@type": "ListItem",
            "position": 1,
            "item": {
              "@id": "{{ shop.url }}/collections",
              "name": {{ 'structured_data.breadcrumbs.collections' | t | json }}
            }
          }
          {% if current_page != 1 %}
            ,
            {
              "@type": "ListItem",
              "position": 2,
              "item": {
                "@id": "{{ shop.url }}/collections",
                "name": {{ 'structured_data.breadcrumbs.page' | t: page: current_page | json }}
              }
            }
          {% endif %}
        {% when 'collection' %}
          {
            "@type": "ListItem",
            "position": 1,
            "item": {
              "@id": "{{ shop.url }}/collections",
              "name": {{ 'structured_data.breadcrumbs.collections' | t | json }}
            }
          },
          {
            "@type": "ListItem",
            "position": 2,
            "item": {
              "@id": "{{ shop.url }}{{ collection_url }}",
              "name": {{ collection.title | json }}
            }
          }
          {% if current_tags %}
            ,
            {
              "@type": "ListItem",
              "position": 3,
              "item": {
                "@id": "{{ shop.url }}{{ collection_url }}/{{- tag_handles | split: '|' | join: '+' -}}",
                "name": {{ 'structured_data.breadcrumbs.tags_html' | t: tags: tag_names | json }}
              }
            }
          {% endif %}
          {% if current_page != 1 %}
            {% if current_tags %}
              {% assign position = 4 %}
            {% else %}
              {% assign position = 3 %}
            {% endif %}
            ,
            {
              "@type": "ListItem",
              "position": {{ position }},
              "item": {
                "@id": "{{ shop.url }}/collections?page={{ current_page }}",
                "name": {{ 'structured_data.breadcrumbs.page' | t: page: current_page | json }}
              }
            }
          {% endif %}
        {% when 'blog' or 'article' %}
          {
            "@type": "ListItem",
            "position": 1,
            "item": {
              "@id": "{{ shop.url }}{{ blog.url }}",
              "name": {{ blog.title | json }}
            }
          }
          {% if template.name == 'article' %}
            ,
            {
              "@type": "ListItem",
              "position": 2,
              "item": {
                "@id": "{{ shop.url }}{{ article.url }}",
                "name": {{ article.title | json }}
              }
            }
          {% elsif current_tags %}
            ,
            {
              "@type": "ListItem",
              "position": 2,
              "item": {
                "@id": "{{ shop.url }}{{ blog.url }}/tagged/{{- tag_handles | split: '|' | join: '+' -}}",
                "name": {{ 'structured_data.breadcrumbs.tags_html' | t: tags: tag_names | json }}
              }
            }
          {% endif %}
          {% if current_page != 1 %}
            {% if current_tags %}
              {% assign position = 3 %}
              {%- capture url -%}
                {{ shop.url }}{{ blog.url }}/tagged/{{ tag_handles | split: '|' | join: '+' }}?page={{ current_page }}
              {%- endcapture -%}
            {% else %}
              {% assign position = 2 %}
                {%- capture url -%}
                {{ shop.url }}{{ blog.url }}?page={{ current_page }}
              {%- endcapture -%}
            {% endif %}
            ,
            {
              "@type": "ListItem",
              "position": {{ position }},
              "item": {
                "@id": "{{ url }}",
                "name": {{ 'structured_data.breadcrumbs.page' | t: page: current_page | json }}
              }
            }
          {% endif %}
        {% when 'search' %}
          {
            "@type": "ListItem",
            "position": 1,
            "item": {
              "@id": "{{ shop.url }}/search",
              "name": {{ 'structured_data.breadcrumbs.search' | t | json }}
            }
          }
          {% if search.performed %}
            {
              "@type": "ListItem",
              "position": 2,
              "item": {
                "@id": "{{ shop.url }}/search?q={{ search.terms }}",
                "name": {{ search.terms | json }}
              }
            }
            {% if current_page != 1 %}
              {
                "@type": "ListItem",
                "position": 3,
                "item": {
                  "@id": "{{ shop.url }}/search?page={{ current_page }}&q={{ search.terms }}",
                  "name": {{ 'structured_data.breadcrumbs.page' | t: page: current_page | json }}
                }
              }
            {% endif %}
          {% endif %}
        {% when 'cart' %}
          {
            "@type": "ListItem",
            "position": 1,
            "item": {
              "@id": "{{ shop.url }}/cart",
              "name": {{ 'structured_data.breadcrumbs.cart' | t | json }}
            }
          }
        {% when 'page' %}
          {
            "@type": "ListItem",
            "position": 1,
            "item": {
              "@id": "{{ page.url }}",
              "name": {{ page.title | json }}
            }
          }
        {% else %}
        {% endcase %}
      ]
    }
  </script>
{% endif %}

{% comment %} Collection faqs data {% endcomment %}
{% if request.page_type == 'collection' and collection %}

{% if collection.metafields.custom.collection_faq != blank %}
{% assign faqs = collection.metafields.custom.collection_faq.value %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {% for faq in faqs %}
    {
      "@type": "Question",
      "name": {{ faq.question | strip_html | strip_newlines | json }},
      "acceptedAnswer": {
        "@type": "Answer",
        "text": {{ faq.answers | metafield_text | strip_newlines | json }}
      }
    }{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ]
}
</script>
{% endif %}
{% endif %}

{% comment %} Product structured data {% endcomment %}

{% if request.page_type == 'product' and product %}
{% assign v = product.selected_or_first_available_variant %}
{% assign price_num = v.price | divided_by: 100.0 %}

{%- comment -%} --- RATING FALLBACKS: Shopify reviews first, then Judge.me --- {%- endcomment -%}
{%- assign rating_count = product.metafields.reviews.rating_count | default: product.metafields.judgeme.badge_review_count -%}
{%- assign rating_num = nil -%}
{%- assign best_rating = 5 -%}
{%- assign worst_rating = 1 -%}

{%- if product.metafields.reviews.rating -%}
  {%- if product.metafields.reviews.rating.value -%}
    {%- assign rating_num = product.metafields.reviews.rating.value.rating -%}
    {%- assign best_rating = product.metafields.reviews.rating.value.scale_max | default: 5 -%}
    {%- assign worst_rating = product.metafields.reviews.rating.value.scale_min | default: 1 -%}
  {%- else -%}
    {%- assign rating_num = product.metafields.reviews.rating -%}
  {%- endif -%}
{%- elsif product.metafields.judgeme.badge_average_rating -%}
  {%- assign rating_num = product.metafields.judgeme.badge_average_rating -%}
{%- endif -%}

{%- comment -%} --- OPTIONAL REVIEW SNIPPET METAFIELDS --- {%- endcomment -%}
{%- assign rev_body   = product.metafields.reviews.top_review_body -%}
{%- assign rev_author = product.metafields.reviews.top_review_author -%}
{%- assign rev_date   = product.metafields.reviews.top_review_date -%}
{%- assign rev_score  = product.metafields.reviews.top_review_rating | default: rating_num -%}

<script type="application/ld+json">
{
  "@context":"https://schema.org",
  "@type":"Product",
  "@id": {{ product.url | absolute_url | append: "#product" | json }},
  "name": {{ product.title | json }},
  "description": {{ product.description | strip_html | strip | json }},
  "sku": {{ v.sku | json }},
  "brand": { "@type":"Brand", "name": {{ product.vendor | default: shop.name | json }} },
  "image": [
    {% for img in product.images limit: 4 %}
      {{ img.src | absolute_url | json }}{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ],
  "offers": {
    "@type":"Offer",
    "url": {{ product.url | absolute_url | json }},
    "priceCurrency": {{ shop.currency | json }},
    "price": {{ price_num | json }},
    "availability": "https://schema.org/InStock",
    "itemCondition": "https://schema.org/NewCondition",
    "sku": {{ v.sku | json }},
    "hasMerchantReturnPolicy": {
      "@type": "MerchantReturnPolicy",
      "returnPolicyCategory": "https://schema.org/ReturnNotPermitted",
      "applicableCountry": "US"
    },
    "shippingDetails": {
      "@type": "OfferShippingDetails",
      "shippingDestination": {
        "@type": "DefinedRegion",
        "addressCountry": "US"
      },
      "shippingRate": {
        "@type": "MonetaryAmount",
        "value": "0.00",
        "currency": {{ shop.currency | json }}
      },
      "deliveryTime": {
        "@type": "ShippingDeliveryTime",
        "handlingTime": {
          "@type": "QuantitativeValue",
          "minValue": 0,
          "maxValue": 0,
          "unitCode": "DAY"
        },
        "transitTime": {
          "@type": "QuantitativeValue",
          "minValue": 21,
          "maxValue": 28,
          "unitCode": "DAY"
        }
      }
    }
  }
  {% if rating_num and rating_count and rating_count > 0 %},
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": {{ rating_num | json }},
    "reviewCount": {{ rating_count | json }},
    "bestRating": {{ best_rating | json }},
    "worstRating": {{ worst_rating | json }}
  }
  {% endif %}
  {% if rev_body or rev_author %},
  "review": [{
    "@type": "Review",
    "author": { "@type": "Person", "name": {{ rev_author | default: 'Verified Buyer' | json }} },
    "reviewRating": {
      "@type": "Rating",
      "ratingValue": {{ rev_score | default: rating_num | json }},
      "bestRating": {{ best_rating | json }},
      "worstRating": {{ worst_rating | json }}
    }{% if rev_date %},
    "datePublished": {{ rev_date | date: "%Y-%m-%d" | json }}{% endif %},
    "reviewBody": {{ rev_body | metafield_tag | strip_html
      | replace: "\r"," " | replace: "\n"," " | replace: "\t"," "
      | replace: "\u00A0"," " | strip | json }}
  }]
  {% endif %}
}
</script>

{% endif %}

{%- if request.page_type == 'product' and product and product.metafields.custom.faqs != blank -%}
  {%- assign faqs_raw = product.metafields.custom.faqs -%}
  {%- assign faqs = faqs_raw.value | default: faqs_raw -%}
  {%- assign any_valid = false -%}
  {%- for faq in faqs -%}
    {%- assign q = faq.question | to_s | strip | strip_html -%}
    {%- assign a_html = faq.answers | metafield_tag -%}
    {%- assign a_txt = a_html | strip | strip_html | replace: "\r"," " | replace: "\n"," " | replace: "\t"," " | replace: "\u00A0"," " -%}
    {%- if q != blank and a_txt != blank -%}{%- assign any_valid = true -%}{%- endif -%}
  {%- endfor -%}
  {%- if any_valid -%}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
  {%- assign first = true -%}
  {%- for faq in faqs -%}
    {%- assign q = faq.question | to_s | strip | strip_html -%}
    {%- assign a_html = faq.answers | metafield_tag -%}
    {%- assign a_txt = a_html | strip | strip_html | replace: "\r"," " | replace: "\n"," " | replace: "\t"," " | replace: "\u00A0"," " -%}
    {%- if q != blank and a_txt != blank -%}
      {%- unless first -%},{%- endunless -%}
      {
        "@type": "Question",
        "name": {{ q | json }},
        "acceptedAnswer": { "@type": "Answer", "text": {{ a_txt | json }} }
      }
      {%- assign first = false -%}
    {%- endif -%}
  {%- endfor -%}
  ]
}
</script>
  {%- endif -%}
{%- endif -%}
