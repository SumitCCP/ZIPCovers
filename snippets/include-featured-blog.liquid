{% comment %}
** Blog posts - dynamic **
- Horizontal scroller with prev/next buttons + auto-scroll + CTA
{% endcomment %}

{% if type == 'block' %}
  {%- assign object = block -%}
{% else %}
  {%- assign object = section -%}
{% endif %}

{%- assign title = object.settings.title -%}
{%- assign blog = blogs[object.settings.blog_widget_select] -%}

{% style %}
/* ===== Scroll wrapper + buttons ===== */
.blog-scroll-outer{
  position:relative;
  max-width:1300px;
  margin:0 auto;
}

/* Buttons */
.blog-scroll-btn{
  position:absolute;
  top:50%;
  transform:translateY(-50%);
  z-index:3;
  width:44px; height:44px;
  border-radius:999px;
  border:1px solid #e0e0e0;
  background:#fff;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
  display:flex; align-items:center; justify-content:center;
  cursor:pointer;
  transition:transform .15s ease, box-shadow .15s ease, opacity .2s ease;
}
.blog-scroll-btn:hover{ box-shadow:0 6px 16px rgba(0,0,0,.12); transform:translateY(-50%) scale(1.03); }
.blog-scroll-btn:active{ transform:translateY(-50%) scale(.98); }
.blog-scroll-btn[disabled]{ opacity:.35; pointer-events:none; }
.blog-scroll-btn--prev{ left:6px; }
.blog-scroll-btn--next{ right:6px; }
.blog-scroll-btn svg{ width:20px; height:20px; }

/* ===== BLOG LIST: always horizontal scroll ===== */
.blog-grid-wrapper{
  position:relative; z-index:1;
  max-width:1300px;
  margin:0 auto;
  display:flex !important;
  flex-wrap:nowrap;
  gap:8px;
  overflow-x:auto;
  overflow-y:hidden;
  padding:0 12px 8px;
  -webkit-overflow-scrolling:touch;
  scrollbar-width:none;
  scroll-snap-type:x proximity;
  white-space:normal;
  overscroll-behavior-x: contain;
}
.blog-grid-wrapper::-webkit-scrollbar{ display:none; }

/* Each card behaves like a slide */
.featured-article.blog-card{
  flex:0 0 clamp(280px, 30vw, 380px);
  max-width:clamp(280px, 30vw, 380px);
  width:auto;
  scroll-snap-align:start;
}

/* ===== BLOG CARD ===== */
.featured-article.blog-card{
  background:#fff;
  border:1px solid #e0e0e0;
  border-radius:10px;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  box-shadow:0 2px 5px rgba(0,0,0,.06);
  transition:box-shadow .3s ease, transform .3s ease;
}
.featured-article.blog-card:hover{
  transform:translateY(-4px);
  box-shadow:0 8px 20px rgba(0,0,0,.1);
}
.blog-card .blog-card__read-more{ margin:0 !important; }

/* Image */
.card-image.blog-card__image{
  width:100%;
  height:220px;
  overflow:hidden;
  position:relative;
  border-bottom:1px solid #e0e0e0;
}
.card-image.blog-card__image img{
  width:100%;
  height:100%;
  object-fit:cover;
  object-position:center;
  display:block;
  transition:none !important;
}

/* Content */
.blog-card__content{
  padding:10px;
  flex:1;
  display:flex;
  flex-direction:column;
}
.blog-card__content .title{
  font-size:18px;
  font-weight:600;
  margin:0 0 5px;
  line-height:1.4;
}
.blog-card__content .title a{ color:#222; text-decoration:none; }

/* Meta */
.meta-info.is-small{ font-size:13px; color:#777; margin-top:auto; }
.meta-info-list{ display:flex; flex-wrap:wrap; gap:10px; padding:0; list-style:none; }
.meta-info-list__item{ display:flex; align-items:center; }

/* Button */
.blog-card__read-more{ padding:10px; }
.blog-card__read-more .button{
  padding:8px 16px;
  font-size:14px;
  background:#000;
  color:#fff;
  border-radius:4px;
  display:inline-block;
  text-decoration:none;
  transition:background-color .3s ease;
}
.blog-card__read-more .button:hover{ background-color:#444; }

/* Section title */
.blog-section-title{
  padding:10px 0;
  text-align:center;
  font-size:2rem;
  margin-bottom:25px;
  font-weight:600;
}
@media (max-width:768px){
  .blog-section-title{ font-size:24px; }
}

/* ===== CTA under scroller ===== */
.blog-section-cta{
  max-width:1300px;
  margin:12px auto;
  text-align:center;
}
.blog-section-cta .button{
  font-size:14px;
  border-radius:6px;
  display:inline-block;
  background:#2A4D4A;
  color:#fff;
}
{% endstyle %}

<section class="
                {{ object.settings.css_class }}
                is-width-{{ object.settings.width }}"
                {% if object.settings.animation != "none" %}
                  data-scroll-class="{{ object.settings.animation }}"
                {% endif %}>

  {% if title != blank %}
    <h2 class="blog-section-title">{{ title }}</h2>
  {% endif %}

  <!-- Scroll outer with buttons -->
  <div class="blog-scroll-outer" data-scope="{{ object.id }}">
    <button type="button"
            class="blog-scroll-btn blog-scroll-btn--prev"
            aria-label="Scroll left"
            aria-controls="blog-scroll-{{ object.id }}">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
           stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
    </button>

    <div id="blog-scroll-{{ object.id }}" class="container blog-grid-wrapper" tabindex="0" aria-label="Blog post list" role="region">
      {% if blog != blank %}
        {% for article in blog.articles limit: object.settings.home_page_articles %}
          <div class="featured-article blog-card {% render 'column-width', value: object.settings.home_page_articles %} columns article card show-border-{{ object.settings.show-border }} medium-down--one-whole has-margin-bottom ">
            {% if article.image != blank %}
              <div class="card-image blog-card__image">
                <figure class="image">
                  <a class="blog-card__link" href="{{ article.url }}" title="{{ article.title | escape }}">
                    {% render 'image-element',
                      image: article.image,
                      alt: article.image.alt,
                      additional_classes: 'blog-card__image',
                      loading: 'lazy',
                      decoding: 'async' %}
                  </a>
                </figure>
              </div>
            {% endif %}

            <div class="card-content blog-card__content">
              <div class="media">
                <div class="media-content">
                  <h3 class="title">
                    <a class="featured-article--link" href="{{ article.url }}" title="{{ article.title | escape }}">{{ article.title }}</a>
                  </h3>
                </div>
              </div>

              {% if article.excerpt != blank and object.settings.blog_show_excerpt %}
                {%- assign postexcerpt = article.excerpt | size -%}
                {% if postexcerpt > 150 %}
                  {%- assign excerptlength = 'lg' -%}
                {% elsif postexcerpt <= 150 %}
                  {%- assign excerptlength = 'sm' -%}
                {% endif %}
                <div class="excerpt excerpt-length-{{ excerptlength }} has-margin-bottom">
                  {{ article.excerpt }}
                  <span class="truncation-fade"></span>
                </div>
              {% endif %}

              <div class="meta-info is-small">
                {% if object.settings.blog_show_tags %}
                  {% if article.tags.size > 0 %}
                    <ul class="meta-tag-list tags">
                      {% for tag in article.tags %}
                        <li class="tag tag--{{ settings.tag_style}}">
                          <a href="{{ shop.url}}/blogs/{{ blog.handle }}/tagged/{{ tag | handleize }}" title="{{ blog.title | escape }} {{ 'blogs.general.tagged' | t }} {{ tag | escape }}">{{ tag }}</a>
                        </li>
                      {% endfor %}
                    </ul>
                  {% endif %}
                {% endif %}

                {% render 'meta-info-list',
                  article: article,
                  blog_author: object.settings.blog_author,
                  blog_date: object.settings.blog_date,
                  blog_read_time: object.settings.read_time,
                  blog_comment_count: object.settings.blog_comment_count %}
              </div>
            </div>

            {% if object.settings.button_type != 'none' %}
              <div class="blog-card__read-more">
                {% render 'button',
                  label: object.settings.button_label,
                  href: article.url,
                  type: "link",
                  style: object.settings.button_type %}
              </div>
            {% endif %}
          </div>
        {% endfor %}
      {% else %}
        {% for i in (1..object.settings.home_page_articles) %}
          <div class="featured-article blog-card {% render 'column-width', value: object.settings.home_page_articles %} columns article card show-border-{{ object.settings.show-border }} medium-down--one-half small-down--one-whole has-margin-bottom">
            <div class="card-image blog-card__image">
              <figure class="image">
                <a href="#">
                  {{ 'image' | placeholder_svg_tag: 'placeholder-svg' }}
                </a>
              </figure>
            </div>

            <div class="card-content blog-card__content">
              <div class="media">
                <div class="media-content">
                  <h4 class="title">
                    <a class="featured-article--link" href="#">{{ 'homepage.onboarding.blogpost_title' | t }}</a>
                  </h4>
                </div>
              </div>

              {% if object.settings.blog_show_excerpt %}
                <div class="excerpt has-margin-bottom">
                  {{ 'homepage.onboarding.blog_excerpt' | t }}
                  <span class="truncation-fade"></span>
                </div>
              {% endif %}

              <div class="meta-info is-small">
                {% if object.settings.blog_show_tags %}
                  <ul class="meta-tag-list tags ">
                    {% for i in (1..3) %}
                      <li class="tag tag--{{ settings.tag_style}}">
                        <a href="#">tag{{i}}</a>
                      </li>
                    {% endfor %}
                  </ul>
                {% endif %}

                {% render 'meta-info-list',
                  article: article,
                  blog_author: object.settings.blog_author,
                  blog_date: object.settings.blog_date,
                  blog_read_time: object.settings.read_time,
                  blog_comment_count: object.settings.blog_comment_count %}
              </div>
            </div>

            {% if object.settings.button_type != 'none' %}
              <div class="blog-card__read-more">
                {% render 'button',
                  label: object.settings.button_label,
                  href: '#',
                  type: "link",
                  style: object.settings.button_type %}
              </div>
            {% endif %}
          </div>
        {% endfor %}
      {% endif %}
    </div>

    <button type="button"
            class="blog-scroll-btn blog-scroll-btn--next"
            aria-label="Scroll right"
            aria-controls="blog-scroll-{{ object.id }}">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
           stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    </button>
  </div>

  <!-- CTA: Read all blogs -->
  <div class="blog-section-cta">
    <a class="button" href="https://zipcushions.com/blogs/journal" rel="noopener">Read Our Blogs</a>
  </div>
</section>

<script>
/* Scoped init so multiple instances work + auto-scroll every 5s */
(function(){
  function init(scopeId){
    var outer = document.querySelector('.blog-scroll-outer[data-scope="'+ scopeId +'"]');
    if(!outer) return;

    var scroller = outer.querySelector('.blog-grid-wrapper');
    var prevBtn  = outer.querySelector('.blog-scroll-btn--prev');
    var nextBtn  = outer.querySelector('.blog-scroll-btn--next');

    var AUTOSCROLL_MS = 5000; // every 5s
    var autoTimer = null;

    var prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    var behavior = prefersReduced ? 'auto' : 'smooth';
    var disableAuto = prefersReduced; // respect OS accessibility setting

    function step(){
      var card = scroller.querySelector('.featured-article.blog-card');
      var styles = getComputedStyle(scroller);
      var gap = parseFloat(styles.gap || styles.columnGap || 16);
      var width = card ? card.getBoundingClientRect().width : scroller.clientWidth * 0.9;
      return Math.round(width + gap);
    }

    function update(){
      var max = scroller.scrollWidth - scroller.clientWidth - 1;
      var atStart = scroller.scrollLeft <= 0;
      var atEnd = scroller.scrollLeft >= max;
      if (prevBtn) prevBtn.disabled = atStart;
      if (nextBtn) nextBtn.disabled = atEnd;
      outer.classList.toggle('at-start', atStart);
      outer.classList.toggle('at-end', atEnd);
    }

    if (prevBtn) prevBtn.addEventListener('click', function(){
      scroller.scrollBy({ left: -step(), behavior });
    });
    if (nextBtn) nextBtn.addEventListener('click', function(){
      scroller.scrollBy({ left:  step(), behavior });
    });

    // Auto-scroll
    function tick(){
      if (scroller.scrollWidth <= scroller.clientWidth + 1) return;
      var max = scroller.scrollWidth - scroller.clientWidth;
      if (Math.ceil(scroller.scrollLeft) >= max) {
        scroller.scrollTo({ left: 0, behavior });
      } else {
        scroller.scrollBy({ left: step(), behavior });
      }
    }
    function startAuto(){
      if (disableAuto || autoTimer) return;
      autoTimer = setInterval(tick, AUTOSCROLL_MS);
    }
    function stopAuto(){
      if (!autoTimer) return;
      clearInterval(autoTimer);
      autoTimer = null;
    }

    // Pause on interaction
    ['mouseenter','focusin','pointerdown','touchstart'].forEach(function(evt){
      outer.addEventListener(evt, stopAuto, { passive: true });
    });
    ['mouseleave','focusout','pointerup','touchend'].forEach(function(evt){
      outer.addEventListener(evt, startAuto, { passive: true });
    });

    // Start/stop when visible
    if ('IntersectionObserver' in window) {
      var io = new IntersectionObserver(function(entries){
        var entry = entries[0];
        if (!entry) return;
        if (entry.isIntersecting) startAuto(); else stopAuto();
      }, { threshold: 0.25 });
      io.observe(outer);
    } else {
      startAuto();
    }

    // Stop when tab hidden
    document.addEventListener('visibilitychange', function(){
      if (document.hidden) stopAuto(); else startAuto();
    });

    scroller.addEventListener('scroll', update, { passive: true });
    window.addEventListener('resize', update);
    update();
  }

  var id = "{{ object.id }}";
  if (document.readyState !== 'loading'){ init(id); }
  else { document.addEventListener('DOMContentLoaded', function(){ init(id); }); }
})();
</script>
